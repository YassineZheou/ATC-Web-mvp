<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>ATC Tunisia - Air Traffic Control</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root {
    --sidebar-width: 380px;
  }

  html, body, #app {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }

  #app {
    display: flex;
    height: 100vh;
  }

  /* Map */
  #map {
    flex: 1;
  }

  /* Sidebar */
  #sidebar {
    width: var(--sidebar-width);
    background: #0b1724;
    color: #e6eef8;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    box-sizing: border-box;
    overflow: hidden;
  }

  #sidebar header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  #sidebar h2 {
    margin: 0;
    font-size: 18px;
    color: #fff;
  }

  #role {
    font-size: 12px;
    color: #9fb2d0;
  }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding: 8px;
    border-radius: 6px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
  }

  /* Aircraft list */
  #planesList {
    max-height: 35vh;
    overflow-y: auto;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .planeItem {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s;
  }

  .planeItem:hover {
    background: rgba(255,255,255,0.08);
  }

  .planeIcon {
    width: 32px;
    height: 32px;
    flex: 0 0 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .planeMeta {
    font-size: 13px;
    flex: 1;
  }

  .callsign {
    font-weight: 700;
    color: #fff;
  }

  .small {
    font-size: 12px;
    color: #9fb2d0;
  }

  /* Alerts journal */
  #alerts {
    max-height: 40vh;
    overflow-y: auto;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .alertItem {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    font-size: 12px;
    color: #ffb3b3;
    line-height: 1.4;
  }

  .alertTime {
    font-size: 11px;
    color: #b0a0a0;
    margin-top: 2px;
  }

  /* Toast notifications */
  #toast {
    position: fixed;
    right: 20px;
    top: 20px;
    z-index: 9999;
    display: none;
    background: rgba(0, 0, 0, 0.85);
    color: #ffb3b3;
    padding: 12px 16px;
    border-radius: 6px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    font-size: 13px;
    max-width: 300px;
  }

  /* Login box */
  #login {
    position: absolute;
    left: 20px;
    top: 20px;
    z-index: 1000;
    background: #ffffff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
  }

  #login h3 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
  }

  #login input {
    padding: 8px;
    margin-bottom: 10px;
    width: 200px;
    display: block;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
  }

  #login button {
    padding: 8px 16px;
    cursor: pointer;
    background: #0b1724;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    width: 100%;
  }

  #login button:hover {
    background: #1a2f4a;
  }

  #loginMsg {
    color: #d32f2f;
    margin-top: 10px;
    font-size: 12px;
  }

  @media (max-width: 1000px) {
    #sidebar {
      width: 320px;
    }
  }
</style>
</head>
<body>
<div id="app">
  <div id="map"></div>

  <div id="sidebar">
    <header>
      <h2>ATC Dashboard</h2>
      <div id="role" class="small">Role: <span id="roleText">unknown</span></div>
    </header>

    <div class="panel">
      <strong class="small">Aircraft (live)</strong>
      <ul id="planesList"></ul>
    </div>

    <div class="panel">
      <strong class="small">Alerts</strong>
      <ul id="alerts"></ul>
    </div>
  </div>
</div>

<div id="toast"></div>

<div id="login">
  <h3>Login</h3>
  <input id="username" placeholder="Username" value="controller1">
  <input id="password" type="password" placeholder="Password" value="1234">
  <button onclick="doLogin()">Login</button>
  <div id="loginMsg"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ============ HELPER FUNCTIONS ============ */

function formatTime(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleTimeString();
}

function getAltitudeColor(altitude) {
  if (altitude < 5000) return '#4ade80';
  if (altitude < 15000) return '#f59e0b';
  return '#ef4444';
}

function getPhaseColor(phase) {
  const colors = {
    'TAXIING': '#94a3b8',
    'TAKING OFF': '#f59e0b',
    'CLIMBING': '#3b82f6',
    'CRUISING': '#10b981',
    'DESCENDING': '#f97316',
    'LANDING': '#dc2626',
  };
  return colors[phase] || '#e6eef8';
}

function createPlaneIcon(color, heading) {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 24 24'>
    <g transform='translate(12,12) rotate(${heading})'>
      <path d='M2 13.5L12 8l10 5.5-2-1.5V18l-4-1-2 2-2-2-4 1v-6z' 
            fill='${color}' stroke='#0b1724' stroke-width='0.5'/>
      <circle cx='0' cy='0' r='2' fill='#fff'/>
    </g>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function formatAltitude(alt) {
  return Math.round(alt).toLocaleString();
}

/* ============ MAP & STATE ============ */

let map;
let markers = new Map();
let ws = null;
let currentUser = null;
let seenAlerts = new Set();

function initMap() {
  if (map) return;
  
  map = L.map('map').setView([35.5, 10.0], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors',
  }).addTo(map);
}

/* ============ UI UPDATES ============ */

function updateAircraftInList(aircraft) {
  const ul = document.getElementById('planesList');
  let li = document.getElementById('plane-' + aircraft.id);
  
  if (!li) {
    li = document.createElement('li');
    li.id = 'plane-' + aircraft.id;
    li.className = 'planeItem';
    li.onclick = () => {
      const marker = markers.get(aircraft.id);
      if (marker) {
        map.setView(marker.getLatLng(), 10, { animate: true });
        marker.openPopup();
      }
    };
    ul.appendChild(li);
  }
  
  const color = getAltitudeColor(aircraft.altitude);
  const phaseColor = getPhaseColor(aircraft.phase);
  li.innerHTML = `
    <div class="planeIcon">
      <img src="${createPlaneIcon(color, aircraft.heading)}" 
           style="width:32px;height:32px;">
    </div>
    <div class="planeMeta">
      <div class="callsign">${aircraft.callsign}</div>
      <div class="small">Alt: ${formatAltitude(aircraft.altitude)}m | Spd: ${aircraft.speed} km/h</div>
      <div class="small" style="color: ${phaseColor}; font-weight: 600;">${aircraft.phase}</div>
    </div>
  `;
}

function removeStaleAircraft(currentIds) {
  const existing = Array.from(markers.keys());
  for (const id of existing) {
    if (!currentIds.includes(id)) {
      const marker = markers.get(id);
      if (marker) map.removeLayer(marker);
      markers.delete(id);
      
      const el = document.getElementById('plane-' + id);
      if (el) el.remove();
    }
  }
}

function addAlert(message, timestamp) {
  const alertKey = message + '_' + Math.floor(timestamp / 1000);
  if (seenAlerts.has(alertKey)) return;
  seenAlerts.add(alertKey);
  
  if (seenAlerts.size > 100) {
    const old = Array.from(seenAlerts)[0];
    seenAlerts.delete(old);
  }
  
  const ul = document.getElementById('alerts');
  const li = document.createElement('li');
  li.className = 'alertItem';
  li.innerHTML = `
    <div>${message}</div>
    <div class="alertTime">${formatTime(timestamp)}</div>
  `;
  ul.insertBefore(li, ul.firstChild);
  
  while (ul.children.length > 20) {
    ul.removeChild(ul.lastChild);
  }
  
  showToast(message);
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 4000);
}

/* ============ WEBSOCKET ============ */

function connectWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(protocol + '//' + window.location.host);
  
  ws.onopen = () => {
    console.log('WebSocket connected');
  };
  
  ws.onmessage = (event) => {
    try {
      const message = JSON.parse(event.data);
      
      if (message.type === 'tracks') {
        updateTracks(message.tracks);
      } else if (message.type === 'alert') {
        addAlert(message.message, message.timestamp);
      }
    } catch (error) {
      console.error('Error parsing message